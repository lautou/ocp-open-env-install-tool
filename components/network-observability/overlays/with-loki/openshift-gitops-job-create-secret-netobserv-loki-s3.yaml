apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    argocd.argoproj.io/sync-options: Force=true
  name: create-secret-netobserv-loki-s3
  namespace: openshift-gitops
spec:
  template:
    metadata:
      name: create-secret-netobserv-loki-s3
    spec:
      containers:
        - name: create-secret-netobserv-loki-s3
          image: registry.redhat.io/openshift4/ose-cli:latest
          command:
            - /bin/bash
            - '-c'
            - |
              echo "Read the secret generated by loki OBC"
              while ! oc get secret netobserv-loki -n netobserv 2>/dev/null 1>&2; do echo "Waiting for secret netobserv-loki in namespace netobserv."; done
              ACCESS_KEY=$(oc get secret netobserv-loki -n netobserv --template={{.data.AWS_ACCESS_KEY_ID}} | base64 -d)
              SECRET_KEY=$(oc get secret netobserv-loki -n netobserv --template={{.data.AWS_SECRET_ACCESS_KEY}} | base64 -d)
              BUCKET_NAME=netobserv-loki
              ENDPOINT=https://s3.openshift-storage.svc
              REGION=eu
              echo "Create the netobserv-loki-s3 secret"
              oc delete secret generic netobserv-loki-s3 -n netobserv --ignore-not-found
              oc create secret generic netobserv-loki-s3 -n netobserv \
              --from-literal access_key_id=$ACCESS_KEY \
              --from-literal access_key_secret=$SECRET_KEY \
              --from-literal bucketnames=$BUCKET_NAME \
              --from-literal endpoint=$ENDPOINT \
              --from-literal region=$REGION \
              --from-literal insecure=true
      nodeSelector:
        node-role.kubernetes.io/infra: ""
      restartPolicy: Never
      serviceAccountName: openshift-gitops-argocd-application-controller
      tolerations:
        - key: node-role.kubernetes.io/infra
          operator: Exists